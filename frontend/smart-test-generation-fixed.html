<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能测试生成 - 智能自动化测试平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <!-- 添加js-yaml库 -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <!-- 确保js-yaml库正确加载 -->
    <script>
        // 检查js-yaml库是否正确加载
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof jsyaml === 'undefined') {
                console.error('js-yaml库未正确加载');
                // 尝试备用CDN
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js';
                script.onload = function() {
                    console.log('js-yaml库通过备用CDN加载成功');
                };
                script.onerror = function() {
                    console.error('js-yaml库加载失败，YAML解析功能可能无法正常工作');
                };
                document.head.appendChild(script);
            } else {
                console.log('js-yaml库已正确加载');
            }
        });
    </script>
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step {
            text-align: center;
            flex: 1;
            position: relative;
            z-index: 1;
        }
        
        .step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            right: -50%;
            height: 2px;
            background-color: #e9ecef;
            z-index: -1;
        }
        
        .step:last-child::before {
            display: none;
        }
        
        .step.active::before {
            background-color: #0d6efd;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        
        .step.active .step-circle {
            background-color: #0d6efd;
            color: white;
        }
        
        .step.completed .step-circle {
            background-color: #198754;
            color: white;
        }
        
        .step-title {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .step.active .step-title {
            color: #0d6efd;
            font-weight: 500;
        }
        
        .step.completed .step-title {
            color: #198754;
        }
        
        .upload-container {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        .upload-container.dragover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        
        .upload-container.uploading {
            border-color: #198754;
            background-color: #d1e7dd;
        }
        
        .upload-container.error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .scene-card {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .scene-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .relation-card {
            margin-bottom: 15px;
            border-left: 4px solid #0d6efd;
        }
        
        .test-case-card {
            margin-bottom: 15px;
            border-left: 4px solid #198754;
        }
        
        .api-badge {
            font-size: 0.8rem;
            padding: 3px 6px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .method-get { background-color: #d1ecf1; color: #0c5460; }
        .method-post { background-color: #d4edda; color: #155724; }
        .method-put { background-color: #fff3cd; color: #856404; }
        .method-delete { background-color: #f8d7da; color: #721c24; }
        .method-patch { background-color: #e2e3e5; color: #41464b; }
        
        .code-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .tab-content {
            min-height: 400px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-robot me-2"></i>智能自动化测试平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="fas fa-home me-1"></i>首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>仪表板
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="api-docs.html">
                            <i class="fas fa-code me-1"></i>API文档
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="test-cases.html">
                            <i class="fas fa-vial me-1"></i>测试用例
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="test-center.html">
                            <i class="fas fa-magic me-1"></i>智能测试生成
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="coverage.html">
                            <i class="fas fa-chart-pie me-1"></i>覆盖度报告
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="suggestions.html">
                            <i class="fas fa-lightbulb me-1"></i>智能建议
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>管理员
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-1"></i>设置</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-question-circle me-1"></i>帮助</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-1"></i>退出</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 面包屑导航 -->
    <div class="container mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html">首页</a></li>
                <li class="breadcrumb-item active">智能测试生成</li>
            </ol>
        </nav>
    </div>

    <!-- 主要内容 -->
    <main class="container mt-4">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">智能测试生成</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" id="resetBtn">
                    <i class="fas fa-redo me-2"></i>重置
                </button>
                <button class="btn btn-primary" id="saveBtn" disabled>
                    <i class="fas fa-save me-2"></i>保存配置
                </button>
            </div>
        </div>

        <!-- 步骤指示器 -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-title">上传API文档</div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-title">分析场景与关联</div>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-title">生成测试用例</div>
            </div>
        </div>

        <!-- 步骤内容 -->
        <div class="card">
            <div class="card-body">
                <!-- 步骤1: 上传API文档 -->
                <div id="step1Content" class="step-content">
                    <h3 class="mb-4">步骤1: 上传API文档</h3>
                    
                    <ul class="nav nav-tabs mb-4" id="apiDocTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">上传文档</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url" type="button" role="tab">URL导入</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab">文本输入</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="apiDocTabContent">
                        <!-- 上传文档标签页 -->
                        <div class="tab-pane fade show active" id="upload" role="tabpanel">
                            <div class="upload-container" id="uploadContainer">
                                <i class="fas fa-cloud-upload-alt file-icon"></i>
                                <h4>拖拽文件到此处或点击上传</h4>
                                <p class="text-muted">支持OpenAPI 3.0.0格式的JSON或YAML文件</p>
                                <input type="file" id="fileInput" accept=".json,.yaml,.yml" style="display: none;">
                                <button class="btn btn-primary" id="uploadBtn">选择文件</button>
                            </div>
                            
                            <div class="upload-progress" id="uploadProgress">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>上传进度</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="file-list" id="fileList"></div>
                        </div>
                        
                        <!-- 飞书URL导入标签页 -->
                        <div class="tab-pane fade" id="url" role="tabpanel">
                            <div class="mb-3">
                                <label for="apiUrl" class="form-label">API文档URL</label>
                                <input type="url" class="form-control" id="apiUrl" placeholder="https://open.feishu.cn/document/server-docs/im-v1/message/create">
                            </div>
                            <button class="btn btn-primary" id="fetchUrlBtn">获取文档</button>
                            <div class="mt-3" id="urlResult"></div>
                        </div>
                        
                        <!-- 文本输入标签页 -->
                        <div class="tab-pane fade" id="text" role="tabpanel">
                            <div class="mb-3">
                                <label for="apiText" class="form-label">OpenAPI文档内容</label>
                                <textarea class="form-control" id="apiText" rows="15" placeholder="粘贴OpenAPI 3.0.0格式的JSON或YAML内容"></textarea>
                            </div>
                            <button class="btn btn-primary" id="parseTextBtn">解析文档</button>
                            <div class="mt-3" id="textResult"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-success btn-lg" id="analyzeBtn" disabled>
                            <i class="fas fa-arrow-right me-2"></i>分析场景与关联关系
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 id="loadingTitle">处理中...</h5>
            <p id="loadingMessage">请稍候，正在处理您的请求</p>
        </div>
    </div>

    <!-- JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    
    <!-- 内联JavaScript代码 -->
    <script>
        // 全局变量
        let currentStep = 1;
        let apiDocData = null;
        let apiEndpoints = [];
        let scenes = [];
        let relations = [];
        let testCases = [];

        // 页面初始化函数
        function initSmartTestGenerationPage() {
            initEventListeners();
            initDragAndDrop();
            // 确保第一步处于活动状态
            updateStepIndicator(1);
            console.log('智能测试生成页面初始化完成');
        }

        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟初始化，确保DOM完全加载
            setTimeout(initSmartTestGenerationPage, 100);
        });

        // 初始化事件监听器
        function initEventListeners() {
            // 文件上传相关
            document.getElementById('uploadBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // 飞书URL导入相关
            document.getElementById('fetchUrlBtn').addEventListener('click', fetchApiFromUrl);
            
            // 文本输入相关
            document.getElementById('parseTextBtn').addEventListener('click', parseApiText);
            
            // 步骤导航
            document.getElementById('analyzeBtn').addEventListener('click', moveToStep2);
            
            // 重置和保存
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            document.getElementById('saveBtn').addEventListener('click', saveConfiguration);
        }

        // 初始化拖拽上传
        function initDragAndDrop() {
            const uploadContainer = document.getElementById('uploadContainer');
            
            uploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadContainer.classList.add('dragover');
            });
            
            uploadContainer.addEventListener('dragleave', function() {
                uploadContainer.classList.remove('dragover');
            });
            
            uploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // 处理文件
        async function handleFile(file) {
            const validTypes = ['application/json', 'text/yaml', 'application/x-yaml', 'text/plain'];
            const validExtensions = ['.json', '.yaml', '.yml'];
            
            // 验证文件类型
            const isValidType = validTypes.includes(file.type) || 
                               validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            
            if (!isValidType) {
                showAlert('请上传有效的OpenAPI文档（JSON或YAML格式）', 'danger');
                return;
            }
            
            // 显示上传进度
            showUploadProgress();
            
            try {
                const content = await readFileContent(file);
                const isYaml = file.name.toLowerCase().endsWith('.yaml') || file.name.toLowerCase().endsWith('.yml');
                
                console.log('文件类型:', isYaml ? 'YAML' : 'JSON');
                console.log('文件内容前100字符:', content.substring(0, 100));
                
                // 解析API文档
                if (isYaml) {
                    console.log('开始解析YAML文档...');
                    console.log('jsyaml库状态:', typeof jsyaml !== 'undefined' ? '已加载' : '未加载');
                    apiDocData = parseYaml(content);
                } else {
                    console.log('开始解析JSON文档...');
                    apiDocData = JSON.parse(content);
                }
                
                console.log('解析结果:', apiDocData);
                
                // 验证OpenAPI版本
                if (!apiDocData.openapi || !apiDocData.openapi.startsWith('3.0.')) {
                    throw new Error('仅支持OpenAPI 3.0.x版本');
                }
                
                // 提取API端点
                extractApiEndpoints();
                
                // 显示文件信息
                displayFileInfo(file.name, file.size);
                
                // 启用分析按钮
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
                
                showAlert('API文档上传成功！', 'success');
            } catch (error) {
                // 提供更详细的错误信息
                let errorMessage = '解析API文档失败';
                
                console.error('完整错误对象:', error);
                console.error('错误消息:', error.message);
                console.error('错误堆栈:', error.stack);
                
                if (error.message.includes('Unexpected token')) {
                    errorMessage = 'JSON格式错误：请检查文件中的JSON语法是否正确';
                } else if (error.message.includes('YAML') || error.message.includes('yaml')) {
                    errorMessage = `YAML格式错误：${error.message}`;
                } else if (error.message.includes('OpenAPI')) {
                    errorMessage = `OpenAPI版本不支持：${error.message}`;
                } else if (error.message.includes('network')) {
                    errorMessage = '网络错误：请检查网络连接或URL是否正确';
                } else {
                    errorMessage = `解析API文档失败: ${error.message}`;
                }
                
                showAlert(errorMessage, 'danger');
                console.error('API文档解析错误:', error);
            } finally {
                hideUploadProgress();
            }
        }

        // 读取文件内容
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // 解析YAML（使用js-yaml库）
        function parseYaml(yamlText) {
            try {
                // 检查是否已加载js-yaml库
                if (typeof jsyaml === 'undefined' && typeof YAML === 'undefined') {
                    throw new Error('YAML解析库未加载，请确保已引入js-yaml库');
                }
                
                // 使用js-yaml库解析YAML
                // 尝试不同的全局变量名
                if (typeof jsyaml !== 'undefined') {
                    return jsyaml.load(yamlText);
                } else if (typeof YAML !== 'undefined') {
                    return YAML.parse(yamlText);
                } else {
                    throw new Error('无法找到YAML解析函数');
                }
            } catch (error) {
                throw new Error(`YAML解析失败: ${error.message}`);
            }
        }

        // 提取API端点
        function extractApiEndpoints() {
            apiEndpoints = [];
            
            if (!apiDocData.paths) return;
            
            Object.keys(apiDocData.paths).forEach(path => {
                const pathItem = apiDocData.paths[path];
                
                ['get', 'post', 'put', 'delete', 'patch', 'head', 'options', 'trace'].forEach(method => {
                    if (pathItem[method]) {
                        apiEndpoints.push({
                            path,
                            method: method.toUpperCase(),
                            operationId: pathItem[method].operationId || `${method}_${path.replace(/\//g, '_')}`,
                            summary: pathItem[method].summary || pathItem[method].description || `${method} ${path}`,
                            tags: pathItem[method].tags || [],
                            parameters: pathItem[method].parameters || [],
                            requestBody: pathItem[method].requestBody,
                            responses: pathItem[method].responses || {}
                        });
                    }
                });
            });
            
            console.log('提取的API端点:', apiEndpoints);
        }

        // 显示文件信息
        function displayFileInfo(fileName, fileSize) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-alt me-3 fs-3"></i>
                        <div>
                            <h6 class="mb-1">${fileName}</h6>
                            <small class="text-muted">大小: ${formatFileSize(fileSize)} | API端点: ${apiEndpoints.length}个</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 显示上传进度
        function showUploadProgress() {
            const uploadContainer = document.getElementById('uploadContainer');
            uploadContainer.classList.add('uploading');
            
            const uploadProgress = document.getElementById('uploadProgress');
            uploadProgress.style.display = 'block';
            
            // 模拟上传进度
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            const interval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 100);
        }

        // 隐藏上传进度
        function hideUploadProgress() {
            const uploadContainer = document.getElementById('uploadContainer');
            uploadContainer.classList.remove('uploading');
            
            const uploadProgress = document.getElementById('uploadProgress');
            uploadProgress.style.display = 'none';
        }

        // 显示提示消息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const fileList = document.getElementById('fileList');
            fileList.appendChild(alertDiv);
            
            // 3秒后自动关闭
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 更新步骤指示器
        function updateStepIndicator(step) {
            // 重置所有步骤
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active', 'completed');
            });
            
            // 标记已完成的步骤
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }
            
            // 标记当前步骤
            document.getElementById(`step${step}`).classList.add('active');
        }

        // 移动到步骤2
        function moveToStep2() {
            currentStep = 2;
            updateStepIndicator(2);
            showAlert('步骤2功能开发中...', 'info');
        }

        // 重置所有
        function resetAll() {
            apiDocData = null;
            apiEndpoints = [];
            scenes = [];
            relations = [];
            testCases = [];
            
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('saveBtn').disabled = true;
            
            showAlert('已重置所有内容', 'info');
        }

        // 保存配置
        function saveConfiguration() {
            // 这里可以实现保存配置的逻辑
            showAlert('配置保存功能开发中...', 'info');
        }

        // 从URL获取API文档
        async function fetchApiFromUrl() {
            const urlInput = document.getElementById('apiUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                showAlert('请输入飞书文档URL', 'warning');
                return;
            }
            
            // 检查URL格式
            if (!url.includes('open.feishu.cn/document/')) {
                showAlert('请输入有效的飞书文档URL', 'warning');
                return;
            }
            
            // 显示进度
            showUploadProgress();
            
            try {
                // 创建AbortController用于超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    showAlert('请求超时，请稍后重试', 'danger');
                    hideUploadProgress();
                }, 60000); // 60秒超时
                
                // 发送请求到后端API
                const response = await fetch('http://localhost:5000/api/docs/fetch-feishu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // 设置API文档数据
                    apiDocData = data.openapi_data;
                    
                    // 提取API端点
                    extractApiEndpoints();
                    
                    // 显示文件信息
                    displayFileInfo(`飞书文档: ${data.path}`, '未知大小');
                    
                    // 启用分析按钮
                    document.getElementById('analyzeBtn').disabled = false;
                    
                    // 显示成功消息
                    showAlert(`成功获取飞书文档，共${apiEndpoints.length}个API端点`, 'success');
                    
                    // 如果有关系数据和场景数据，也保存起来
                    if (data.relation_data) {
                        // 这里可以处理关系数据
                        console.log('获取到关系数据:', data.relation_data);
                    }
                    
                    if (data.scene_data) {
                        // 这里可以处理场景数据
                        console.log('获取到场景数据:', data.scene_data);
                    }
                } else {
                    throw new Error(data.message || '获取文档失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('请求已取消', 'warning');
                } else {
                    showAlert(`获取文档失败: ${error.message}`, 'danger');
                }
                console.error('获取文档错误:', error);
            } finally {
                hideUploadProgress();
            }
        }

        // 解析API文本
        function parseApiText() {
            showAlert('文本解析功能开发中...', 'info');
        }
    </script>
</body>
</html>